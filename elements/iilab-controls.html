<link rel="import" href="../components/polymer/polymer.html">
<!--<link rel="import" href="../components/core-tooltip/core-tooltip.html">-->
<link rel="import" href="../components/paper-input/paper-input.html">
<link rel="import" href="../components/paper-slider/paper-slider.html">
<link rel="import" href="../components/paper-button/paper-button.html">

<polymer-element name="iilab-controls" noscript attributes="strings cypher depth">
  <template>
	<style>
	  core-submenu::shadow #submenu {
	    margin-left: 10px;
	  }

	  core-submenu::shadow core-item::shadow core-icon {
	    fill:#2a3e92;
	  }

	  paper-input {
	  	max-width:222px;
	  }

	</style>
    <core-menu valueattr="label" id="core_menu" theme="core-light-theme" on-core-select="{{selectAction}}" vertical layout>
      <core-submenu id="saved_queries" icon="bookmark" label="Saved Queries">
        <core-submenu id="saved_queries_bp" icon="bookmark" label="BP">
          <paper-item label="BP PLC Subsidiaries (Depth 1)" id="bp_plc_1"></paper-item>
          <paper-item label="BP PLC Subsidiaries (Depth 2)" id="bp_plc_2"></paper-item>
          <paper-item label="BP PLC Subsidiaries (Depth 3 - Slow!)" id="bp_plc_3"></paper-item>
<!--          <paper-item label="BP PLC Subsidiaries and Countries (Depth 2)" id="bp_plc_countries_2"></paper-item>
          <paper-item label="BP PLC Subsidiaries and Countries (Depth 3)" id="bp_plc_countries_3"></paper-item>
          <paper-item label="BP PLC Subsidiaries and Countries (Depth 4)" id="bp_plc_countries_4"></paper-item>-->
        </core-submenu> 
        <core-submenu id="saved_queries_nigeria" icon="bookmark" label="Nigeria">
            <paper-item label="Production contracts" id="nigeria_production"></paper-item>
            <paper-item label="Service contracts" id="nigeria_service"></paper-item>
            <paper-item label="SNEPCO all connections" id="nigeria_snepco"></paper-item>
        </core-submenu> 
      </core-submenu> 
      <core-submenu id="advanced_settings" icon="settings" label="Advanced Settings">
        <div vertical layout>
		    <div>These settings control more advanced aspects of the visualisation.</div>
		    <div>
				<core-tooltip>
				  <h5>Depth</h5>
				  <div>Depth controls how many relationships are followed when displaying nodes of interest. This will be applied when you double click on a node.</div>
				</core-tooltip>
			    <paper-slider id="depth" pin="" snaps="" min="1" max="4" step="1" value="{{depth}}" editable></paper-slider>
		    </div>
				<core-tooltip>
				  <h5>Raw Query</h5>
				  <div>The OpenOil database uses Neo4j and its query language <a href="http://docs.neo4j.org/chunked/stable/cypher-query-lang.html">Cypher</a>. You can directly enter Cypher queries in this box.</div>
				</core-tooltip>
			<paper-input id="cypher" flex multiline rows="5" label="Cypher Query"></paper-input>
			<paper-button affirmative default icon="done" label="Apply" on-click="{{buttonClick}}"></paper-button>
		</div>
      </core-submenu> 
    </core-menu>
  </template>
  <script> 
  	Polymer('iilab-controls', {
		ready: function () {
	        document.addEventListener('load-graph-query', this.loadGraphQuery);
		},
		buttonClick: function(e, detail, sender) {
//			console.log(document.querySelector('iilab-drawer-panel'))
			this.depth;
			this.cypher = this.$.cypher.value;
		},
		selectAction: function(e, detail) {
		  console.log("selectAction")
	      if (detail.isSelected) {
	        var selectedItem = detail.item;
	        this.menuSelect(selectedItem.id);
//	        console.log(selectedItem.id)
	      }
		},
		loadGraphQuery: function(e) {
			console.log("loadGraphQuery")
			console.log(e.detail.id)
			document.querySelector('openoil-app').shadowRoot.querySelector('iilab-controls').menuSelect(e.detail.id)
		},
		menuSelect: function(id) {
			console.log("menuSelect")
			this.fire('stats', {i: id, t:"q"});
	        switch(id) {
/*				case "bp_plc_countries_2":
					this.depth = "2"
				    this.cypher = "MATCH (n:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(m:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(n:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[s:IS_OWNER*0.." + this.depth + "]-(o)-[r:HAS_JURISDICTION]->(n:Country) RETURN n, labels(n) as label, r"
				    break;
				case "bp_plc_countries_3":
					this.depth = "3"
				    this.cypher = "MATCH (n:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(m:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(n:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[s:IS_OWNER*0.." + this.depth + "]-(o)-[r:HAS_JURISDICTION]->(n:Country) RETURN n, labels(n) as label, r"
				    break;
				case "bp_plc_countries_4":
					this.depth = "4"
				    this.cypher = "MATCH (n:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(m:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(n:Company)-[j:HAS_JURISDICTION]->(c) RETURN n, labels(n) as label, r UNION MATCH (m:Company {name: 'BP P L C'})-[s:IS_OWNER*0.." + this.depth + "]-(o)-[r:HAS_JURISDICTION]->(n:Country) RETURN n, labels(n) as label, r"
				    break;*/
				case "bp_plc_1":
					this.depth = "2"
				    this.cypher = "MATCH p=(a:Company {name: 'BP P L C'})-[r:IS_OWNER*0..1]->(n) UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, label: labels(x), id: id(x)}], links: collect(DISTINCT links)} as result"
				    break;
				case "bp_plc_2":
					this.depth = "2"
				    this.cypher = "MATCH p=(a:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(n) UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, label: labels(x), id: id(x)}], links: collect(DISTINCT links)} as result"
				    break;
				case "bp_plc_3":
					this.depth = "3"
				    this.cypher = "MATCH p=(a:Company {name: 'BP P L C'})-[r:IS_OWNER*0.." + this.depth + "]->(n) UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, label: labels(x), id: id(x)}], links: collect(DISTINCT links)} as result"
				    break;
				case "nigeria_production":
					this.cypher = "MATCH p=(a:Company)<-[hc:HAS_CONTRACTOR]-(c:Contract)<-[i:AWARDS]-(b {name: 'Nigerian National Petroleum Corporation (NNPC)'}) WITH p, a,c, hc,b,i MATCH (c)-[:HAS_CONTRACT_TYPE]->(ct:ContractType {name: 'Production Contract'}) UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, id: id(x), label: labels(x)}], links: collect(DISTINCT links)} as result"
				    break;
				case "nigeria_service":
					this.cypher = "MATCH p=(k)-[:HAS_JURISDICTION]-(a:Company)<-[hc:HAS_CONTRACTOR]-(c:Contract)<-[i:AWARDS]-(b)-[:HAS_JURISDICTION]-(j) WITH p, a,c, hc,b,i, k MATCH (c)-[:HAS_CONTRACT_TYPE]->(ct:ContractType {name: 'Service Contracts'}) UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, id: id(x), label: labels(x)}], links: collect(DISTINCT links)} as result"
				    break;
				case "nigeria_snepco":
				 	this.cypher = "MATCH p=(company:Company)-[r:IS_OWNER*..3]-(a {name: 'Shell Nigeria Exploration and Production Company (SNEPCO)'})-[:AWARDS|HAS_OPERATOR]-(c)-[:HAS_CONTRACTOR|HAS_OPERATOR]-(d) WHERE id(d)<>635603 UNWIND nodes(p) as nodes UNWIND relationships(p) as links RETURN {nodes: [ x in collect(DISTINCT nodes) | {node: x, id: id(x), label: labels(x)}], links: collect(DISTINCT links)} as result"
				    break;
				default:
				    break;
			}
		}
	})
  </script>
</polymer-element>