<link rel="import" href="../components/polymer/polymer.html">
<link rel="import" href="../components/font-roboto/roboto.html">
<link rel="import" href="../components/core-scaffold/core-scaffold.html">
<link rel="import" href="../components/core-header-panel/core-header-panel.html">
<link rel="import" href="../components/core-field/core-field.html">
<link rel="import" href="../components/core-icon/core-icon.html">
<link rel="import" href="../components/core-icons/iconsets/image-icons.html">
<link rel="import" href="../components/core-icons/iconsets/av-icons.html">
<link rel="import" href="../components/core-item/core-item.html">
<link rel="import" href="../components/core-menu/core-menu.html">
<link rel="import" href="../components/core-menu/core-submenu.html">
<link rel="import" href="../components/core-menu-button/core-menu-button.html">
<link rel="import" href="../components/core-icon-button/core-icon-button.html">
<link rel="import" href="../components/core-toolbar/core-toolbar.html">
<link rel="import" href="../components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../components/paper-slider/paper-slider.html"> 
<link rel="import" href="../components/paper-shadow/paper-shadow.html"> 
<link rel="import" href="../components/paper-item/paper-item.html"> 
<link rel="import" href="../components/paper-button/paper-button.html"> 
<link rel="import" href="../components/paper-icon-button/paper-icon-button.html"> 
<link rel="import" href="../components/paper-menu-button/paper-menu-button.html"> 
<link rel="import" href="../components/iilab-drawer-panel/iilab-drawer-panel.html">
<link rel="import" href="../components/core-transition/core-transition-css.html">
<link rel="import" href="../components/core-overlay/core-overlay.html">
<link rel="import" href="../components/core-ajax/core-xhr.html">
<link rel="import" href="iilab-graph.html"> 
<link rel="import" href="iilab-map.html"> 
<link rel="import" href="iilab-controls.html"> 
<link rel="import" href="iilab-search.html"> 

<polymer-element name="x-dialog" attributes="opened autoCloseDisabled">
<template>
  <style>

    :host {
      box-sizing: border-box;
      -moz-box-sizing: border-box;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 13px;
      -webkit-user-select: none;
      -moz-user-select: none;
      overflow: hidden;
      background: white;
      padding:30px 42px;
      outline: 1px solid rgba(0,0,0,0.2);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    }
  </style>
  <core-overlay id="overlay" layered backdrop opened="{{opened}}" autoCloseDisabled="{{autoCloseDisabled}}"  transition="core-transition-center"></core-overlay>
  <content></content>
</template>
<script>

Polymer('x-dialog', {

  ready: function() {
    this.$.overlay.target = this;
  },

  toggle: function() {
    this.$.overlay.toggle();
  }

});

</script>
</polymer-element>

<polymer-element name="openoil-app" noscript>
  <template>
  <link rel="stylesheet" href="../components/jquery-ui/themes/ui-lightness/jquery-ui.css">

  <style shim-shadowdom>
    core-scaffold core-toolbar {
      background: #EEE;
      color: #2a3e92;
    }

    core-drawer-panel #main > [main] {
     background: #FFF; 
    }
  </style>
  <style>

    core-header-panel {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch; 
    }

  /*  polyfill-unscoped-rule {
      content: 'core-scaffold core-toolbar';
      background: #EEE;
      color: black;
    }

    polyfill-unscoped-rule {
      content: 'core-scaffold core-header-panel';
      background: #FFF;
      color: black;
    } */

    core-scaffold::shadow core-toolbar {
      background: #EEE;
      color: #2a3e92;
    }
    core-scaffold::shadow core-header-panel {
      background: #FFF;
      color: #2a3e92;
    }

    .container {
      width: 80%;
      margin: 50px auto;
    }

    :host {
      position: absolute;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      color: #2a3e92;
    }
    #core_toolbar {
      right: 0px;
      color: #2a3e92;
      fill: rgb(255, 255, 255);
      background-color: rgb(235, 235, 235);
    }
    #core_drawer_panel {
      position: absolute;
      top: 0px;
      right: 0px;
      bottom: 0px;
      left: 0px;
    }
    #core_icon {
      height: 24px;
      width: 24px;
    }

    core-icon-button::shadow core-icon {
      fill: #2a3e92 ;
    }

    #core_card {
      width: 300px;
      height: 300px;
      border-top-left-radius: 2px;
      border-top-right-radius: 2px;
      border-bottom-right-radius: 2px;
      border-bottom-left-radius: 2px;
      box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
      left: 20px;
      top: 80px;
      position: absolute;
      background-color: rgb(255, 255, 255);
    }

    .ui-widget {
      font-family: RobotoDraft, sans-serif;
    }

    .ui-widget-content .ui-state-focus {
      color: #2a3e92;
      background: none;
      border: none;
    }

    #iilab_map {
      width:100%;
      height:100%;
    }

  </style>
  <core-xhr id="xhr"></core-xhr>
  <x-dialog id="dialog" class="dialog" style="overflow-y: scroll">
      <!-- place all overlay styles inside the overlay target -->
      <style>
        .dialog {
          box-sizing: border-box;
          -moz-box-sizing: border-box;
          font-family: Arial, Helvetica, sans-serif;
          font-size: 13px;
          -webkit-user-select: none;
          -moz-user-select: none;
          overflow: hidden;
          background: white;
          padding:30px 42px;
          outline: 1px solid rgba(0,0,0,0.2);
          box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        #dialog {
          top:10%;
          width: 80%;
          height: 80%;
        }

        #dialog div#bp, #dialog div#nigeria {
          margin:15px;
        }

        #dialog img{
          width:100%;
        }

        #dialog p {
          font-size:1em;
        }

        #dialog paper-icon-button {
          width: 200px;
        }

        img[core-overlay-toggle] {
          cursor: pointer;
        }

      </style>
      <div layout horizontal center>
        <core-icon icon="home" size="45px" style="margin-right:15px;"></core-icon>
        <h2>OpenOil: Corporate Network Navigator</h2>
      </div>
      <div layout horizontal>
        <div id="bp" layout vertical center flex one>
          <h4>BP Corporate Structure</h4>
          <img src="/img/map.png" core-overlay-toggle id="bp_map" on-click="{{clickQuery}}"/>
          <paper-icon-button raisedButton core-overlay-toggle label="BP" id="bp_map" on-click="{{clickQuery}}"></paper-icon-button>
          <p>With over 1,000 affiliate companies in more than 80 jurisdictions, BP controls a complex network of corporate entities. This map of BP's corporate structure shows their ownership relations, using only public disclosures that BP itself has made. It also includes key financials for 150 of the companies registered in the UK. Here's how the tool works:
<ol><li>Click on a country to see all BP entities registered there, along with their ownership chains three levels up.</li>
<li>Follow the ownership chains up: there may be up to 12 layers of ownership before you get to the ultimate owner, UK-registered BP plc.</li>
<li>Double-click on a jurisdiction to see other companies registered there; double-click on a company to show its other connections.</li>
<li>Use the search bar to find specific companies of interest.</li></ol>
<p>Click to check: every data point in this network includes a citable URL to verify the assertion - feel free to use this information to facilitate your investigations into BP's activities in your country. There may be up to 12 layers of ownership before you get to the ultimate owner, UK-registered BP plc. Go ahead and play!
</p><p>
<a href="http://openoil.net/corporate-networks/bp-corporate-network/" target="_blank"/>Learn more </a>
</p>
        </div>
        <div id="nigeria" layout vertical center flex one>
          <h4>Oil contracts and companies in Nigeria</h4>
          <img src="/img/nigeria.png" core-overlay-toggle id="nigeria_production" on-click="{{clickQuery}}"/>
          <paper-icon-button raisedButton core-overlay-toggle label="Nigeria" id="nigeria_production" on-click="{{clickQuery}}"></paper-icon-button>
          <p>There are hundreds of oil companies operating in Nigeria, but beyond the big names like Shell and Exxon, the nature of most of these companies is poorly understood outside industry circles. This network graph aims to shed more light on the sector, by showing how companies in Nigeria's oil and gas sector are connected through...
<ol><li>"Primary" production contracts: <a href="/#nigeria_production" id="nigeria_production" core-overlay-toggle on-click="{{clickQuery}}">which companies produce Nigeria's oil</a>.</li>
<li>"Secondary" service contracts: <a href="/#nigeria_service" id="nigeria_service" core-overlay-toggle on-click="{{clickQuery}}">which companies own the rights to lucrative service subcontracts?</a></li></ol>  
<p>The graph also shows the range of connections of individual companies - their contracts as well as their ownership structures. One example is the Shell affiliate  <a href="/#nigeria_snepco" id="nigeria_snepco" core-overlay-toggle on-click="{{clickQuery}}">Shell affiliate 'Shell Nigeria Exploration and Production Company (SNEPCO)'</a>. But that's only one point of entry: click on any entity, or any connection between entities, to reveal more information. 
</p><p>
<a href="http://openoil.net/corporate-networks/nigeria-corporate-network" target="_blank"/>Learn more </a>
</p>
        </div>
      </div>
      <div id="footer" horizontal flex>
      This is a large data set requiring a good internet connection, which works best with an updated version of the Google Chrome browser. For any questions please contact&nbsp;<a href="mailto:anton.ruehling@openoil.net">anton.ruehling@openoil.net</a>.
      </div>
      <core-overlay layered id="confirmation" class="dialog" backdrop transition="core-transition-top">
        <!-- place all overlay styles inside the overlay target -->
        <style>
          .dialog {
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            -webkit-user-select: none;
            -moz-user-select: none;
            overflow: hidden;
            background: white;
            padding:30px 42px;
            outline: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
          }

          #confirmation {
            box-sizing: border-box;
            text-align: center;
            width: 150px;
          }
        </style>
      </core-overlay>
      <br><br>
    </x-dialog>

    <x-dialog id="download-dialog" class="dialog" style="overflow-y: scroll; display:none;">
      <!-- place all overlay styles inside the overlay target -->
      <style>
        .dialog {
          box-sizing: border-box;
          -moz-box-sizing: border-box;
          font-family: Arial, Helvetica, sans-serif;
          font-size: 13px;
          -webkit-user-select: none;
          -moz-user-select: none;
          overflow: hidden;
          background: white;
          padding:30px 42px;
          outline: 1px solid rgba(0,0,0,0.2);
          box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        #dialog {
          top:10%;
          width: 80%;
          height: 80%;
        }

        #dialog div#bp, #dialog div#nigeria {
          margin:15px;
        }

        #dialog img{
          width:100%;
        }

        #dialog p {
          font-size:1em;
        }

        #dialog paper-icon-button {
          width: 200px;
        }

        img[core-overlay-toggle] {
          cursor: pointer;
        }

      </style>
      <div layout horizontal center>
        <core-icon icon="home" size="45px" style="margin-right:15px;"></core-icon>
        <h2>OpenOil: Corporate Network Navigator</h2>
      </div>
      <div layout horizontal>
        <div id="tabular" layout vertical center flex one>
          <h3>Tabular Data</h3>
          <h4>Nigeria ( Companies / Contracts / Ownership ) - 20140822</h4>
          <div layout horizontal><core-item icon="cloud-download" label="Nigeria_20140822.tgz"><a href="/data/Nigeria_20140822.tgz" download="Nigeria_20140822.tgz"></a></core-item>&nbsp;&nbsp;&nbsp;<core-item icon="cloud-download" label="Nigeria_20140822.zip"><a href="/data/Nigeria_20140822.zip" download="Nigeria_20140822.zip"></a></core-item></div><br><br>
          <h4>BP ( Ownership ) - 20140822</h4>
          <div layout horizontal><core-item icon="cloud-download" label="BP_20140822.tgz"><a href="/data/BP_20140822.tgz" download="BP_2014022.tgz"></a></core-item>&nbsp;&nbsp;&nbsp;<core-item icon="cloud-download" label="BP_20140822.zip"><a href="/data/BP_20140822.zip" download="BP_20140822.zip"></a></core-item></div>
        </div>
        <div id="graph" layout vertical center flex one>
          <h3>Graph Data</h3>
          <h4>Neo4j JSON export</h4>
          <div layout horizontal><core-item icon="cloud-download" label="neo4j_20140822.tgz"><a href="/data/neo4j_20140822.tgz" download="neo4j_20140822.tgz"></a></core-item>&nbsp;&nbsp;&nbsp;<core-item icon="cloud-download" label="neo4j_20140822.zip"><a href="/data/neo4j_20140822.zip" download="neo4j_20140822.zip"></a></core-item></div><br><br>
          <h4>JSON-LD (soon)</h4>
        </div>
      </div>
      <div id="footer" horizontal flex>
      <br/>
      This data is published by OpenOil UG under the <a href="http://opendatacommons.org/licenses/odbl/1.0/">Open Database License (ODbL) v1.0.</a> Open Oil and iilab are working towards publishing the Open Oil Data set as Linked Data. For any questions please contact&nbsp;<a href="mailto:anton.ruehling@openoil.net">anton.ruehling@openoil.net</a>.
      </div>
      <core-overlay layered id="download-confirmation" class="dialog" backdrop transition="core-transition-top">
        <!-- place all overlay styles inside the overlay target -->
        <style no-shim>
          .dialog {
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 13px;
            -webkit-user-select: none;
            -moz-user-select: none;
            overflow: hidden;
            background: white;
            padding:30px 42px;
            outline: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
          }

          #confirmation {
            box-sizing: border-box;
            text-align: center;
            width: 150px;
          }
        </style>
      </core-overlay>
      <br><br>
    </x-dialog>

    <core-scaffold id="core_scaffold">
      <core-header-panel mode="seamed" id="core_header_panel" navigation flex>
        <core-toolbar id="core_toolbar">
          <core-icon-button icon="home" id="home" on-click="{{homeClick}}"></core-icon-button>
          <core-icon-button icon="menu" id="core_icon_button"></core-icon-button>
        </core-toolbar>
        <core-icon src="/openoil_logo.png" size="128" style="margin-left:55px"></core-icon> 
        <core-field id="core_field" icon="search">
          <iilab-search search="{{searchText}}" id="iilab_search"></iilab-search>
        </core-field>
        <iilab-controls id="iilab_controls" cypher="{{cypherText}}" depth="{{depthValue}}"></iilab-controls>
        <paper-shadow z="1"></paper-shadow>
      </core-header-panel>
      <div id="div" tool horizontal layout center wrap flex>
        <div id="title" >Open&nbsp;Oil Data - Beta</div>
        <div id="oc" style="font-size:0.6em;">&nbsp;&nbsp;&nbsp;In partnership with <img src="/img/logo_oc.png" style="vertical-align:middle;"></div>
        <div id="count" flex><template if="{{countNodesValue}}">&nbsp;- {{countNodesValue.node}} nodes &amp; {{countLinksValue.links}} links</template></div>
        <div>&nbsp;</div>
        <core-tooltip>
          <h5>Zoom</h5>
          <div tip>Drag the slider to change the zoom level.</div>
        </core-tooltip>
        <paper-slider id="zoom_slider" pin="" snaps="" min="-3.5" max="1" step="0.05" value="{{zoomSlider}}"></paper-slider>
<!--        <paper-icon-button id="zoom_out" icon="image:crop-free" role="button" tabindex="0" class="" on-click="{{zoomOut}}"></paper-icon-button>-->
        <core-item icon="mail" id="request_mail"><h5><a href="mailto:data.request@openoil.net" style="color: inherit;">Request Additional Data</a></h5></core-item>
        <paper-menu-button icon="more-vert" valign="bottom" halign="right">
          <core-item icon="visibility" label="OpenOil.net"><a href="http://openoil.net"></a></core-item>
          <core-item icon="extension" label="License"><a href="http://openoil.net/corporate-network-data-license/"></a></core-item>
          <core-item icon="info" label="Methodology"><a href="http://openoil.net/corporate-network-methodology/"></a></core-item>
          <core-item icon="info" label="Mapping BP - Essay"><a href="http://openoil.net/mapping-bp-using-open-data-to-track-big-oil/"></a></core-item>
        </paper-menu-button>      
      </div>
      <div id="selection"></div>
      <iilab-graph id="iilab_graph" cypher="{{cypherText}}" search="{{searchText}}" url="{{url}}" zoom="{{zoom}}" autozoom="{{autozoom}}" depth="{{depthValue}}" count="{{countValue}}" style="display:none;"></iilab-graph>
      <iilab-map id="iilab_map" countnodes="{{countNodesValue}}" countlinks="{{countLinksValue}}"></iilab-map>
      <!--<core-card id="core_card" layout vertical></core-card>-->
    </core-scaffold>
  </template>
  <script> 
  	Polymer('openoil-app', {
      url: (window.location.href == 'http://localhost/')?'http://db.localhost:7474/db/data/' : 'https://neo4j.openoil.net/db/data/',
      zoom: 0,
      zoomSlider: 0,
  		published: {
  			title: ""
  		},
      ready: function() {
        this.addEventListener('set-slider', this.sliderSet);
        document.addEventListener('stats', this.statsReq);
      },
      domReady: function() {
        console.log(window.location.hash.replace(/^#/, ''))
        this.url = (window.location.href.split('/')[2] == 'localhost')?'http://db.localhost:7474/db/data/' : 'https://neo4j.openoil.net/db/data/'
        this.loadURL(window.location.hash.replace(/^#/, ''))
      },
      clickQuery: function(e) {
        window.location.hash = "#" + e.target.id;
        this.loadURL(e.target.id)
        this.fire('stats', {i: e.target.id, t:"c"});
      },
      loadURL: function(id) {
        switch(id) {
          case "bp_plc_1":
          case "bp_plc_2":
          case "bp_plc_3":
          case "nigeria_production":
          case "nigeria_service":
          case "nigeria_snepco":
            this.$.iilab_graph.style.display = "block";
            this.$.iilab_map.style.display = "none";
            this.fire('stats', {i: window.location.href, t:"l"});
            this.fire('load-graph-query', {id: id});
            break;
          case "bp_map":
            this.$.iilab_graph.style.display = "none";
            this.$.iilab_map.style.display = "block";
            this.$.iilab_map.loadMap();
            this.fire('stats', {i: window.location.href, t:"l"});
            break;
          default:
            this.fire('stats', {i: window.location.href, t:"h"});
            this.$.dialog.toggle();
            break;
        }
      },
      statsReq: function(e) {
        // simple web server based logging
        //   the format is ?i=indicator&t=type
        //
        // types:
        // ------
        //
        // h : home page (welcome page) / i: access url
        // c : click on one of the home page links / i: link id
        // l : load 

        document.querySelector('openoil-app').shadowRoot.querySelector('#xhr').request({url:"/", params: { i: e.detail.i, t: e.detail.t, _ : new Date().getTime()}})
      },
      homeClick: function() {
        window.location.hash = "#";
        this.fire('stats', {i: window.location.href, t:"h"});
        this.$.dialog.toggle();
      },
  		buttonClick: function(e, detail, sender) {
  			//document.querySelector('iilab-graph').shadowRoot.querySelector('#drawer').togglePanel();
  		},
      searchTextChanged: function(o, n) {
//        console.log(n)
      },
      stringsTextChanged: function(o, n) {
      },
      zoomOut: function() {
        this.$.iilab_graph.zoom = 0;
      },
      sliderSet: function(e) {
        console.log("openoil-app zoomChanged")
        console.log(e.detail.zoom)
        this.zoomSlider = Math.round(Math.log(e.detail.zoom)*20)/20
      },
      zoomSliderChanged: function(o,n) {
        console.log("openoil-app zoomSliderChanged")
        console.log(n)
        console.log(Math.exp(Math.round(n*20)/20))
        this.fire('zoom-slider', {zoom: Math.exp(Math.round(n*20)/20)})
//        this.$.iilab_graph.zoom = Math.exp(Math.round(n*20)/20);
//        this.$.iilab_graph.autozoom = false;
      }
  	})
  </script>
</polymer-element>